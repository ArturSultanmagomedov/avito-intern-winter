# Тестовое задание для набора на стажировку в AvitoTech (зима 2022)

<img alt="alt" height="108" src="./images/PngItem_4242405.png" width="160"/>

Выполнил Султанмагомедов Артур


### Спойлер: вы можете запустить приложение одной командой `make run`

**предполагается что у вас установлен docker*

### Но перед запуском настроим конфиги

В папке `configs` находится файл `config.yaml` с основными настройками.

```yaml
host: <хост сервера откуда вы будете запускать микросервис>
port: <порт на котором сервис будет крутиться>

db:
  username: <юзернейм владельца базы>
  host: <адрес сервера где висит бд>
  port: <порт который используется базой>
  dbname: <имя базы>
  sslmode: <SSL мод>

log:
  output: <каталог где будут сохраняться логи>
  level: <уровень логов debug|info|error|fatal|panic|warning|trace>
```

Так же в корне проекта лежит файл `.env`. (Вообще то предполагается что его в публичном репозитории быть не должно, но
т.к. мне надо обьяснить что тут вообще происходит, он здесь.)
В нем всего одно значение - пароль от базы данных `DB_PASSWORD=<пароль>`

### Немного об архитектуре приложения

Приложение написано с использованием чистой архитектуры, и разделено на три слоя handler, service и repository

слой handler отвечает за общение с клиентом

repository - общается с базой даных

service - реализует бизнес-логику и связывает между собой слои handler и repository

### Тестирование

<img alt="alt" src="./images/go_tests.svg" width="90"/>

Для всей основной логики приложения написаны unit-тесты.
Процент покрытия тестами составляет 78%.

### Так же для сервиса доступна swagger документация по адресу `/swagger/index.html`

<img alt="alt" height="100" src="./images/go_logs.png" width="160"/>

### Далее будут представленны описания запросов

*(Возможно с этого стоило начать, но это только возможно :) )*

---

*1. Метод начисления средств на баланс. Принимает id пользователя и сколько средств зачислить.*

формат:

POST запрос по адресу `/api/v1/add_funds`

тело запроса:

```
{ "id": <целое число>, "sum": <число дробное, строго положительное> }
```

возвращает статус-код

пример запроса:
`curl --location --request POST 'localhost:8000/api/v1/add_funds' --header 'Content-Type: application/json' --data-raw '{
"id": 1843,
"sum": 500 }'`

---

*2. Метод списания средств с баланса. Принимает id пользователя и сколько средств списать.*

формат:

POST запрос по адресу `/api/v1/write_off_funds`

тело запроса:

```
{ "id": <целое число>, "sum": <число дробное, строго положительное> }
```

возвращает статус-код

пример запроса:
`curl --location --request POST 'localhost:8000/api/v1/write_off_funds' --header 'Content-Type: application/json' --data-raw '{
"id": 177,
"sum": 3200 }'`

---

*3. Метод перевода средств от пользователя к пользователю. Принимает id пользователя с которого нужно списать средства,
id пользователя которому должны зачислить средства, а также сумму.*

формат:

POST запрос по адресу `/api/v1/funds_transfer`

тело запроса:

```
{ "id1": <целое число>, "id2": <целое число>, "sum": <число дробное, строго положительное> }
```

возвращает статус-код

пример запроса:
`curl --location --request POST 'localhost:8000/api/v1/funds_transfer' --header 'Content-Type: application/json' --data-raw '{
"id1": 3,
"id2": 4,
"sum": 750 }'`

---

*4. Метод получения текущего баланса пользователя. Принимает id пользователя. Баланс всегда в рублях.*

*(upd: добавлена возможность получения баланса в отличной от рубля валюты)*

формат:

GET запрос по адресу `/api/v1/get_balance` при необходимости можно добавить параметр `?currency=<тикер>`

тело запроса:

```
{ "id": <целое число> }
```

возвращает статус-код и единственное число - значение баланса (при условии что статус-код - 200)

пример запроса:
`curl --location --request GET 'localhost:8000/api/v1/get_balance?currency=USD' --header 'Content-Type: application/json' --data-raw '{
"id": 4 }'`

**ошибки со всех методов приходят в формате `{"message": <текст ошибки>}` вместе со статус-кодом*

**котировки обновляются каждые 6 часов*

---

### Используемые библиотеки и фреймворки

1. gin - фреймворк для работы с сетью
2. viper - библиотека для парсинга конфигурационных файлов
3. godotenv - библиотека для парсинга .env файлов
4. go-sqlmock - генератор моков для базы данных
5. gomock - генератор моков на основе интерфейсов
6. logrus - библиотека для логирования
7. testify - фреймворк для написания unit-тестов
8. swag - генератор swagger документации

Список валют подтягивается с `https://www.cbr-xml-daily.ru/daily_json.js`
